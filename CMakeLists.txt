cmake_minimum_required(VERSION 3.14)
project(ReactiveStateMachine VERSION 1.0.0 LANGUAGES C CXX)

# =============================================================================
# ë¹Œë“œ ë””ë ‰í† ë¦¬ ê²€ì¦
# =============================================================================

# ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ë‚´ ë¹Œë“œ ë°©ì§€
if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
    message(FATAL_ERROR 
        "
âŒ ERROR: In-source builds are not allowed!
"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"
        "Please create a separate build directory:
"
        "  mkdir build
"
        "  cd build
"
        "  cmake ..
"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
")
endif()

# build ë””ë ‰í† ë¦¬ ì´ë¦„ ê²€ì¦
get_filename_component(BUILD_DIR_NAME "${CMAKE_BINARY_DIR}" NAME)
if(NOT BUILD_DIR_NAME MATCHES "^(build|Build|BUILD|Debug|Release|_build)$")
    message(FATAL_ERROR 
        "
âŒ ERROR: Please use standard build directory name!
"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"
        "Current directory: '${BUILD_DIR_NAME}'
"
        "Allowed names: build, Build, BUILD, Debug, Release, _build
"
        "
"
        "Correct usage:
"
        "  mkdir build
"
        "  cd build
"
        "  cmake ..
"
        "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
")
endif()

message(STATUS "âœ… Building in correct directory: ${BUILD_DIR_NAME}")

# C++20 í‘œì¤€ ì‚¬ìš©
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ì„¤ì¹˜ ê²½ë¡œë¥¼ ìœ„í•œ GNUInstallDirs í¬í•¨
include(GNUInstallDirs)

# ìœ„ì¹˜ ë…ë¦½ì  ì½”ë“œ ìƒì„± (ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ìœ„í•´)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ì»´íŒŒì¼ ì˜µì…˜ ì„¤ì •
if(MSVC)
    add_compile_options(/W4)
else()
    add_compile_options(-Wall -Wextra -pedantic)
endif()

# libxml++5.0 ì°¾ê¸°
find_package(PkgConfig REQUIRED)
pkg_check_modules(LIBXMLPP REQUIRED "libxml++-5.0 >= 5.0.0")

# Boost ë¼ì´ë¸ŒëŸ¬ë¦¬ ì°¾ê¸°
find_package(Boost 1.65 REQUIRED)

# ğŸ“ Modular Architecture - Add subdirectories
add_subdirectory(rsm)            # Unified RSM library with integrated parsing
add_subdirectory(tools/codegen)  # Code generation tool

# í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì˜µì…˜ (ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”)
option(BUILD_TESTS "Build the tests" ON)
if(BUILD_TESTS)
    enable_testing()
    add_subdirectory(tests)
endif()

# ì„¤ì¹˜ ì„¤ì • (GNUInstallDirs ë³€ìˆ˜ ì‚¬ìš©)
install(TARGETS rsm_unified scxml-codegen
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

install(DIRECTORY
        rsm/include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
    FILES_MATCHING PATTERN "*.h"
)

# íŒ¨í‚¤ì§€ êµ¬ì„±
include(CMakePackageConfigHelpers)
write_basic_package_version_file(
    "${CMAKE_CURRENT_BINARY_DIR}/StateMachineConfigVersion.cmake"
    VERSION ${PROJECT_VERSION}
    COMPATIBILITY SameMajorVersion
)

# StateMachineConfig.cmake íŒŒì¼ ìƒì„±
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake/StateMachineConfig.cmake.in
    ${CMAKE_CURRENT_BINARY_DIR}/StateMachineConfig.cmake
    @ONLY
)

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
install(
    FILES
        "${CMAKE_CURRENT_BINARY_DIR}/StateMachineConfig.cmake"
        "${CMAKE_CURRENT_BINARY_DIR}/StateMachineConfigVersion.cmake"
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/StateMachine
)
